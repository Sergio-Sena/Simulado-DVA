name: Deploy DVA-C02 Course

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

env:
  AWS_REGION: 'us-east-1'

jobs:
  # Job de valida√ß√£o e testes
  validate:
    name: Validate & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate HTML
        run: |
          echo "Validating HTML files..."
          for file in *.html; do
            if [[ -f "$file" ]]; then
              echo "Checking $file..."
              grep -q "<!DOCTYPE html>" "$file" || (echo "Missing DOCTYPE in $file" && exit 1)
              grep -q "<html" "$file" || (echo "Missing html tag in $file" && exit 1)
              grep -q "</html>" "$file" || (echo "Missing closing html tag in $file" && exit 1)
            fi
          done
      
      - name: Validate JavaScript
        run: |
          echo "Validating JavaScript files..."
          for file in *.js; do
            if [[ -f "$file" ]]; then
              echo "Checking $file..."
              node -c "$file" || (echo "Syntax error in $file" && exit 1)
            fi
          done
      
      - name: Check file sizes
        run: |
          echo "Checking file sizes..."
          find . -name "*.html" -o -name "*.css" -o -name "*.js" | while read file; do
            size=$(stat -c%s "$file" 2>/dev/null || echo 0)
            if [ "$size" -gt 1048576 ]; then
              echo "Warning: $file is larger than 1MB ($size bytes)"
            fi
          done

  # Deploy para Development
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/develop'
    environment: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Sync to S3 Development
        run: |
          aws s3 sync . s3://dva-c02-course-dev-${{ secrets.AWS_ACCOUNT_ID }} --delete --exclude ".git/*" --exclude ".github/*" --exclude "*.md"
      
      - name: Invalidate CloudFront
        run: |
          DISTRIBUTION_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?Comment=='dva-c02-course-dev'].Id" --output text)
          if [ ! -z "$DISTRIBUTION_ID" ]; then
            aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*"
          fi
      
      - name: Comment PR with dev URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üöÄ Development deployment successful!\n\nüìç **Dev URL**: https://dev-dva.sstechnologies-cloud.com\n\n‚úÖ Ready for testing!'
            })

  # Deploy para Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Sync to S3 Staging
        run: |
          aws s3 sync . s3://dva-c02-course-staging-${{ secrets.AWS_ACCOUNT_ID }} --delete --exclude ".git/*" --exclude ".github/*" --exclude "*.md"
      
      - name: Invalidate CloudFront
        run: |
          DISTRIBUTION_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?Comment=='dva-c02-course-staging'].Id" --output text)
          if [ ! -z "$DISTRIBUTION_ID" ]; then
            aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*"
          fi
      
      - name: Run smoke tests
        run: |
          echo "Running smoke tests on staging..."
          sleep 30
          curl -f https://staging-dva.sstechnologies-cloud.com || echo "Site not ready yet"

  # Deploy para Production (manual approval)
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate, deploy-staging]
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Create deployment tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "v1.0.$(date +%Y%m%d%H%M%S)" -m "Production deployment $(date)"
      
      - name: Sync to S3 Production
        run: |
          aws s3 sync . s3://dva-c02-course-prod-${{ secrets.AWS_ACCOUNT_ID }} --delete --exclude ".git/*" --exclude ".github/*" --exclude "*.md"
      
      - name: Invalidate CloudFront
        run: |
          DISTRIBUTION_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?Comment=='dva-c02-course-prod'].Id" --output text)
          if [ ! -z "$DISTRIBUTION_ID" ]; then
            aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*"
          fi
      
      - name: Verify production deployment
        run: |
          echo "Verifying production deployment..."
          sleep 30
          curl -f https://dva.sstechnologies-cloud.com || echo "Production deployment completed"

  # Rollback job (manual trigger)
  rollback:
    name: Rollback to Stable
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment: production
    steps:
      - name: Checkout stable version
        uses: actions/checkout@v4
        with:
          ref: v1.0-stable
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Rollback to stable version
        run: |
          aws s3 sync . s3://dva-c02-course-prod-${{ secrets.AWS_ACCOUNT_ID }} --delete --exclude ".git/*" --exclude ".github/*" --exclude "*.md"
          echo "Rollback to stable version completed!"